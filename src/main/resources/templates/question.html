<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
<head>
    <div th:replace="fragments/head :: header"></div>
    <link rel="stylesheet" th:href="@{/css/question.css}">
    <link rel="stylesheet" th:href="@{/css/modal.css}">

    <title th:text="${question.getTitle()} + ' - Townsq'"></title>
</head>
<body>
<header th:replace="fragments/header.html :: header"></header>
<div class="modal clickable">
    <div class="modal-background">
        <p class="close" th:onclick="closeModal()">X</p>
        <form id="comment-form" role="form" th:action="''" th:method="post">
            <div class="row justify-space-between">
                <div class="col-12">
                    <div class="form-control">
                        <input type="hidden" th:value="${question.getId()}" th:name="question" th:id="question" />
                        <label for="text-input">Comentário</label>
                        <input type="text" name="text" id="text-input"/>
                    </div>
                </div>
            </div>
            <div class="row white-background">
                <button type="submit" onclick="submitCommentForm()">Cadastrar</button>
            </div>
        </form>
    </div>
</div>
<div id="contentDiv" class="justify-center relative">
    <main class="main-content">
        <div class="question-card-actions">
            <div class="question-page-main-card">
                <div class="main-card-left">
                    <img alt="Imagem do perfil do usuário" src="/img/user.svg"/>
                    <div class="name-last-access">
                        <p th:text="${question.getUser().getName()}"></p>
                        <small th:text="${question.getCreatedAtString()}"></small>
                    </div>
                </div>
                <div class="main-card-right">
                    <div class="question-title">
                        <p th:text="${question.getTitle()}"></p>
                    </div>
                    <div class="question-text">
                        <p th:text="${question.getDescription()}"></p>
                    </div>
                </div>
            </div>
            <div sec:authorize="isAuthenticated()" th:if="${#authentication.getPrincipal().id==question.getUser().getId()}" class="action-icons">
                <a th:href="@{/question/edit/{id}(id=${question.getId()})}"><img alt="editar" th:src="@{/img/icons/lapis.svg}"/></a>
                <a th:href="@{/question/delete/{id}(id=${question.getId()})}"><img alt="deletar" th:src="@{/img/icons/lixeira.svg}"/></a>
            </div>
        </div>
        <div class="status-pill-questions self-end bg-danger">
            <small>Não solucionada</small>
        </div>
            <div class="add-comment self-end" th:onclick="|updateModal('question;${question.id}')|">
                <img alt="Adicionar Comentário" th:src="@{/img/icons/add_comment.svg}"/>
                <small>Adicionar um Comentário</small>
            </div>
        <div class="comments">
            <div class="comment-actions" th:each="comment : ${question.getComments()}">
                <div class="comment-card">
                    <div class="comment-left">
                        <small th:text="${comment.getText()}"></small>
                    </div>
                    <div class="comment-right">
                        <a th:href="'/user/' + ${comment.getUser().getId()}"><small th:text="${comment.getUser().getName()}"></small></a>
                    </div>
                </div>
                <div class="action-icons-comment" sec:authorize="isAuthenticated()" th:if="${#authentication.getPrincipal().id == comment.getUser().getId()}">
                    <a href="#"><img th:src="@{/img/icons/lapis.svg}"/></a>
                    <a th:href="'/comment/delete/' + ${question.getId()}"><img th:src="@{/img/icons/lixeira.svg}"/></a>
                </div>
            </div>
        </div>
        <hr>
        <div class="answer-textarea-container">
            <h2>Digite sua resposta</h2>
            <div sec:authorize="${!isAnonymous()}" class="answer-textarea-button">
                <textarea th:disabled="!${#request.userPrincipal}"></textarea>
                <button class="button-default bg-light-green" th:disabled="!${#request.userPrincipal}">Responder pergunta</button>
            </div>
            <div sec:authorize="${isAnonymous()}" class="required-login-banner">
                <h1>Você não está logado.</h1>
                <h2>Entre com sua conta ou cadastre-se para responder.</h2>
            </div>
        </div>
        <div class="question-answers">
            <div class="answer-card">
                <div class="answer-card-left">
                    <img alt="Imagem do perfil do usuário" src="/img/user.svg"/>
                    <div class="name-last-access">
                        <p>Bruno Almeida</p>
                        <small>2 horas</small>
                    </div>
                </div>
                <div class="answer-card-right">
                    <div class="question-text">
                        <p>No prédio em que sou síndico está tendo uma discussão durante as reuniões sobre a presença q...</p>
                    </div>
                </div>
            </div>
            <div class="comments">
                <div class="comment-card">
                    <div class="comment-left">
                        <small>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</small>
                    </div>
                    <div class="comment-right">
                        <small>Bruno Silva</small>
                    </div>
                </div>
                <div class="comment-card">
                    <div class="comment-left">
                        <small>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</small>
                    </div>
                    <div class="comment-right">
                        <small>Fulano Jr.</small>
                    </div>
                </div>
            </div>
            <div class="answer-card">
                <div class="answer-card-left">
                    <img alt="Imagem do perfil do usuário" src="/img/user.svg"/>
                    <div class="name-last-access">
                        <p>Bruno Almeida</p>
                        <small>2 horas</small>
                    </div>
                </div>
                <div class="answer-card-right">
                    <div class="question-text">
                        <p>No prédio em que sou síndico está tendo uma discussão durante as reuniões sobre a presença q...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<div th:replace="fragments/toast.html :: toasts">
</div>
<script defer>

    document.querySelector('#comment-form').addEventListener('submit', function (e){
        e.preventDefault()
    })

    function updateModal(referer) {

        const modal = document.querySelector(".modal");
        const header = document.querySelector("header");
        const mainDiv = document.querySelector("#contentDiv");
        const form = document.querySelector('#comment-form');

        const split = referer.split(';');
        form.action = `/comment/create/${split[0]}/${split[1]}`

        if(modal.style.opacity === '1') {
            modal.style.opacity = '0'
            modal.style.zIndex = '-99999';
            mainDiv.style.zIndex = '';
            header.style.zIndex = '';
        }
        else
            modal.style.opacity = '1'
            modal.style.zIndex = '99999'
            modal.style.pointerEvents = 'auto'
            mainDiv.style.zIndex = '-1';
            header.style.zIndex = '-1';
    }

    function closeModal() {
        const modal = document.querySelector(".modal");
        const header = document.querySelector("header");
        const mainDiv = document.querySelector("#contentDiv");
        const form = document.querySelector('#comment-form');

        form.action = ''

        modal.style.opacity = '0'
        modal.style.zIndex = '-99999';
        modal.style.pointerEvents = 'none'
        mainDiv.style.zIndex = '';
        header.style.zIndex = '';
    }

    function submitCommentForm(){
        document.querySelector('#comment-form').submit()
    }
</script>
</body>
</html>